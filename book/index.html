<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Echoes of the Machine War · Phase 1</title>

<!-- Docsify + Themeable (lets us style easily) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsify-themeable@0/dist/css/theme-simple.css">
<link rel="stylesheet" href="assets/style.css">
</head>
<body>
  <div id="app"></div>

  <script>
    window.$docsify = {
      name: 'Echoes of the Machine War',
      repo: '',
      loadSidebar: true,
      subMaxLevel: 2,
      auto2top: true,
      coverpage: true,
      // Search (simple client-side)
      search: 'auto',
      // Pagination (prev/next)
      pagination: {
        crossChapter: true,
        crossChapterText: true,
      }
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/docsify@4/lib/docsify.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/docsify/lib/plugins/search.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/docsify-pagination/dist/docsify-pagination.min.js"></script>
<script>
  window.$docsify = window.$docsify || {};
  window.$docsify.plugins = (window.$docsify.plugins || []).concat(function (hook, vm) {
    function getRoutes() {
      return Array.from(document.querySelectorAll('.sidebar-nav a'))
        .map(a => a.getAttribute('href'))
        .filter(Boolean);
    }
    function ensurePagerEl() {
      let el = document.querySelector('.pager');
      if (!el) {
        el = document.createElement('div');
        el.className = 'pager';
        el.innerHTML = '<a class="btn prev" style="visibility:hidden"></a><div class="spacer"></div><a class="btn next" style="visibility:hidden"></a>';
        document.body.appendChild(el);
      }
      return el;
    }
    function updatePager() {
      const routes = getRoutes();
      const cur = vm.router.getCurrentPath();               // e.g. 'phase-1/'
      const hashCur = '#/' + cur.replace(/^\//,'');
      const i = routes.indexOf(hashCur);
      const el = ensurePagerEl();
      const prev = i > 0 ? routes[i-1].replace(/^#\//,'') : null;
      const next = i >= 0 && i < routes.length-1 ? routes[i+1].replace(/^#\//,'') : null;
      const prevA = el.querySelector('.prev');
      const nextA = el.querySelector('.next');
      if (prev) {
        prevA.href = '#/' + prev;
        prevA.textContent = '← Prev';
        prevA.style.visibility = 'visible';
      } else {
        prevA.style.visibility = 'hidden';
      }
      if (next) {
        nextA.href = '#/' + next;
        nextA.textContent = 'Next →';
        nextA.style.visibility = 'visible';
      } else {
        nextA.style.visibility = 'hidden';
      }
    }
    function ensureProgressEl() {
      if (!document.querySelector('.progress')) {
        const bar = document.createElement('div');
        bar.className = 'progress';
        const span = document.createElement('span');
        bar.appendChild(span);
        document.body.appendChild(bar);
      }
    }
    function updateProgress() {
      const scroller = document.querySelector('.content');
      if (!scroller) return;
      const y = scroller.scrollTop;
      const h = scroller.scrollHeight - scroller.clientHeight;
      const pct = h > 0 ? (y / h) * 100 : 0;
      const span = document.querySelector('.progress span');
      if (span) span.style.width = pct + '%';
    }

    hook.ready(function () {
      ensureProgressEl();
      document.addEventListener('scroll', updateProgress, true);
    });
    hook.doneEach(function () {
      setTimeout(() => { updatePager(); updateProgress(); }, 30);
    });
  });
</script>
<script>
/**
 * Docsify plugin: progress bar + prev/next based on _sidebar.md
 * - On cover (#/), Next jumps to the first entry in _sidebar.md
 * - On regular pages, Prev/Next follow sidebar order
 * - Progress bar updates on scroll
 */
(function () {
  let navOrder = [];

  async function loadSidebar() {
    if (navOrder.length) return navOrder;
    try {
      const res = await fetch('./_sidebar.md?_=' + Date.now());
      const md  = await res.text();
      const re  = /\[([^\]]+)\]\(([^)]+)\)/g;
      let m; navOrder = [];
      while ((m = re.exec(md)) !== null) {
        const href = m[2].trim();
        if (href.startsWith('http') || href.startsWith('#')) continue;
        navOrder.push({ title: m[1].trim(), href });
      }
    } catch (e) {
      console.warn('Failed loading _sidebar.md', e);
    }
    return navOrder;
  }

  function cleanRoutePath(p) {
    return (p || '').replace(/^\#\//,'').replace(/^\.\//,'').replace(/\/+$/,'');
  }

  function computePager(route) {
    const curr = cleanRoutePath(route.path);
    const first = navOrder[0] || null;
    // If we're on the cover (empty path), treat "current" as before first item
    if (!curr) return { prev: null, next: first };

    const idx = navOrder.findIndex(x => cleanRoutePath(x.href) === curr);
    if (idx === -1) {
      // Unknown route (e.g., manual hash) -> default to first as "next"
      return { prev: null, next: first };
    }
    const prev = idx > 0 ? navOrder[idx - 1] : null;
    const next = idx < navOrder.length - 1 ? navOrder[idx + 1] : null;
    return { prev, next };
  }

  function setLink(el, item, fallbackText) {
    if (!el) return;
    if (item) {
      el.removeAttribute('disabled');
      el.href = '#/' + cleanRoutePath(item.href);
      el.textContent = item.title;
    } else {
      el.setAttribute('disabled', 'true');
      el.href = '#/';
      el.textContent = fallbackText;
    }
  }

  function updatePagerLinks(route) {
    const prevEl = document.getElementById('pager-prev');
    const nextEl = document.getElementById('pager-next');
    if (!prevEl || !nextEl) return;

    const { prev, next } = computePager(route);
    setLink(prevEl, prev, 'Start');
    setLink(nextEl, next, 'End');

    // Optional: hide pager on cover if you want no controls there.
    // const onCover = !cleanRoutePath(route.path);
    // document.getElementById('pager').style.display = onCover ? 'none' : 'flex';
  }

  function updateProgress() {
    const bar = document.getElementById('progress');
    const sc  = document.scrollingElement || document.documentElement;
    const max = Math.max(1, sc.scrollHeight - sc.clientHeight);
    const pct = Math.min(100, Math.max(0, (sc.scrollTop / max) * 100));
    if (bar) bar.style.width = pct + '%';
  }

  function onKey(e) {
    const LEFT = 37, RIGHT = 39;
    if (e.keyCode === LEFT) {
      const a = document.getElementById('pager-prev');
      if (a && !a.hasAttribute('disabled')) a.click();
    } else if (e.keyCode === RIGHT) {
      const a = document.getElementById('pager-next');
      if (a && !a.hasAttribute('disabled')) a.click();
    }
  }

  window.$docsify = window.$docsify || {};
  window.$docsify.plugins = (window.$docsify.plugins || []).concat(function (hook, vm) {
    hook.init(async function () {
      await loadSidebar();
      updatePagerLinks(vm.route);
      updateProgress();
      document.addEventListener('scroll', updateProgress, { passive: true });
      document.addEventListener('keydown', onKey);
    });
    hook.doneEach(function () {
      updatePagerLinks(vm.route);
      setTimeout(updateProgress, 50);
    });
  });
})();
</script>
<!-- reading progress bar + pager anchors -->
<div id="progress"></div>
<nav id="pager">
  <a class="prev" id="pager-prev" href="#" aria-label="Previous chapter"></a>
  <a class="next" id="pager-next" href="#" aria-label="Next chapter"></a>
</nav>
</body>
</html>
